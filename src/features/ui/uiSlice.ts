import { createSlice, PayloadAction } from "@reduxjs/toolkit";

/**
 * ТИПЫ ДЛЯ СИСТЕМЫ ПОЛЬЗОВАТЕЛЬСКОГО ИНТЕРФЕЙСА
 * 
 * Определяют допустимые значения для различных аспектов UI:
 * - Theme: цветовая схема приложения
 * - SortKey: варианты сортировки статей
 */
type Theme = "dark" | "light";
type SortKey = "new" | "old" | "az" | "za" | "author";

/**
 * СОСТОЯНИЕ ПОЛЬЗОВАТЕЛЬСКОГО ИНТЕРФЕЙСА
 * 
 * Хранит настройки UI, которые сохраняются между сессиями:
 * - theme: текущая цветовая тема
 * - search: поисковый запрос
 * - limit: количество элементов на странице (пагинация)
 * - start: смещение для пагинации
 * - sort: текущий способ сортировки
 */
type UiState = {
  theme: Theme;
  search: string;
  limit: number;
  start: number;
  sort: SortKey;
};

/**
 * КОНСТАНТЫ ДЛЯ ВАЛИДАЦИИ СОРТИРОВКИ
 * 
 * Массив допустимых значений сортировки для проверки входящих данных
 */
const SORTS: readonly SortKey[] = ["new", "old", "az", "za", "author"] as const;

/**
 * ФУНКЦИЯ НОРМАЛИЗАЦИИ ПАРАМЕТРА СОРТИРОВКИ
 * 
 * Защищает от некорректных значений сортировки:
 * - Проверяет, что переданное значение есть в списке допустимых
 * - Возвращает значение по умолчанию "new" для неизвестных значений
 */
const normalizeSort = (v: unknown): SortKey =>
  (SORTS.includes(v as SortKey) ? (v as SortKey) : "new");

/**
 * НАЧАЛЬНОЕ СОСТОЯНИЕ UI
 * 
 * Инициализирует состояние с учетом сохраненных пользовательских предпочтений:
 * - Тема читается из localStorage, по умолчанию "dark"
 * - Параметры пагинации и поиска устанавливаются в значения по умолчанию
 */
const initialState: UiState = {
  theme: (localStorage.getItem("fw_theme") as Theme) || "dark", // Восстанавливаем тему из localStorage
  search: "",              // Пустой поисковый запрос
  limit: 20,               // 20 элементов на странице
  start: 0,                // Начинаем с первой страницы
  sort: "new",             // Сортировка по новизне (последние сначала)
};

/**
 * SLICE ДЛЯ УПРАВЛЕНИЯ СОСТОЯНИЕМ ПОЛЬЗОВАТЕЛЬСКОГО ИНТЕРФЕЙСA
 * 
 * Обрабатывает действия, связанные с настройками UI и навигацией:
 * - Управление темой приложения
 * - Обработка поисковых запросов
 * - Пагинация и сортировка
 * - Сброс состояния
 */
const slice = createSlice({
  name: "ui",
  initialState,
  reducers: {
    /**
     * УСТАНОВКА ЦВЕТОВОЙ ТЕМЫ ПРИЛОЖЕНИЯ
     * 
     * Сохраняет выбранную тему в localStorage для сохранения между сессиями
     * Фактическое применение темы через класс на <html> выполняется в App.tsx
     */
    setTheme(s, a: PayloadAction<Theme>) {
      s.theme = a.payload;
      localStorage.setItem("fw_theme", s.theme);
      // Переключение класса на <html> делает App.tsx
    },

    /**
     * УСТАНОВКА ПОИСКОВОГО ЗАПРОСА
     * 
     * При изменении поискового запроса сбрасывает пагинацию на первую страницу,
     * чтобы пользователь всегда видел релевантные результаты с начала
     */
    setSearch(s, a: PayloadAction<string>) {
      s.search = a.payload;
      s.start = 0; // при новом поиске — с первой страницы
    },

    /**
     * УСТАНОВКА ПАРАМЕТРОВ ПАГИНАЦИИ
     * 
     * Управляет отображением постраничной навигации:
     * - start: смещение (какую страницу показывать)
     * - limit: количество элементов на странице
     */
    setPaging(s, a: PayloadAction<{ start: number; limit: number }>) {
      s.start = a.payload.start;
      s.limit = a.payload.limit;
    },

    /**
     * УСТАНОВКА СПОСОБА СОРТИРОВКИ
     * 
     * Принимает строку и нормализует ее к допустимому значению
     * При изменении сортировки сбрасывает пагинацию на первую страницу
     */
    setSort(s, a: PayloadAction<string>) {
      s.sort = normalizeSort(a.payload);
      s.start = 0;
    },

    /**
     * СБРОС СОСТОЯНИЯ ГЛАВНОЙ СТРАНИЦЫ
     * 
     * Возвращает параметры UI к значениям по умолчанию:
     * - Очищает поисковый запрос
     * - Сбрасывает пагинацию на первую страницу
     * - Устанавливает сортировку по умолчанию
     * 
     * Не затрагивает theme и limit, так как это пользовательские предпочтения
     */
    resetHome(s) {
      s.search = "";
      s.start = 0;
      s.sort = "new";
      // limit и theme не трогаем (пользовательские настройки)
    },
  },
});

// ЭКСПОРТ ДЕЙСТВИЙ ДЛЯ ИСПОЛЬЗОВАНИЯ В КОМПОНЕНТАХ
export const {
  setTheme,
  setSearch,
  setPaging,
  setSort,
  resetHome,        // ← не забыть экспортировать
} = slice.actions;

// ЭКСПОРТ РЕДЮСЕРА ДЛЯ ПОДКЛЮЧЕНИЯ В STORE
export default slice.reducer;





// Комментарии объясняют:

// 1. Архитектуру управления состоянием UI

// Централизованное хранение всех настроек пользовательского интерфейса
// Сохранение состояния между сессиями через localStorage
// Согласованное поведение across всего приложения

// 2. Систему тем и внешнего вида

// Поддержка светлой и темной темы для комфорта пользователя
// Автоматическое сохранение выбора темы в браузере
// Интеграцию с App.tsx для применения CSS классов

// 3. Механизмы поиска и фильтрации

// Умный сброс пагинации при изменении поискового запроса
// Нормализацию входных данных для защиты от ошибок
// Синхронизацию параметров поиска, сортировки и пагинации

// 4. Пагинацию и навигацию

// Гибкую систему пагинации с настраиваемым размером страницы
// Сброс к первой странице при изменении условий отображения
// Сохранение пользовательских предпочтений (limit не сбрасывается)

// 5. Функциональность сброса состояния

// Избирательный сброс только тех параметров, которые влияют на отображение контента
// Сохранение пользовательских настроек (тема, размер страницы)
// Удобство использования для возврата к исходному состоянию

// Этот слайс обеспечивает надежное и предсказуемое управление 
// состоянием пользовательского интерфейса в Warhammer 40,000 Fandom Wiki, 
// значительно улучшая пользовательский опыт за счет сохранения предпочтений и 
// интеллектуального управления навигацией.


