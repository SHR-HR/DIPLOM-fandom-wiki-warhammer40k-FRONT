import { z } from "zod";

/**
 * ВАЛИДАТОРЫ ДЛЯ WARHAMMER 40,000 FANDOM WIKI
 * 
 * Этот файл содержит все схемы валидации для форм приложения
 * Используется библиотека Zod для строгой типизации и валидации данных
 */

/** ===== ВАЛИДАТОРЫ ФОРМЫ ПО ТЕХНИЧЕСКОМУ ЗАДАНИЮ ===== */

/**
 * Проверяет, является ли строка допустимым URL изображения
 * Разрешенные форматы:
 * - data:image/ (base64 encoded images)
 * - blob: (временные blob URL)
 * - /uploads/ | /media/ (локальные пути к загруженным файлам)
 * - http/https URL с графическими расширениями
 * 
 * @param v - строка для проверки
 * @returns boolean - true если URL валиден для изображения
 */
function isOkImgUrl(v: string): boolean {
  if (!v) return false;
  const s = v.trim();

  // Разрешаем data URL для изображений (base64)
  if (s.startsWith("data:image/")) return true;
  // Разрешаем blob URL (временные URL для загружаемых файлов)
  if (s.startsWith("blob:")) return true;

  // Разрешаем локальные пути к загруженным медиафайлам
  if (s.startsWith("/uploads/") || s.startsWith("/media/")) return true;

  // Для внешних HTTP/HTTPS URL требуем наличие графического расширения
  if (/^https?:\/\//i.test(s)) {
    return /\.(webp|gif|jpe?g|png)$/i.test(s);
  }
  return false;
}

/**
 * Универсальный валидатор для полей с изображениями
 * Проверяет строку на соответствие критериям валидного URL изображения
 * Используется для previewImg, аватаров и контентных изображений
 */
export const imgLike = z
  .string()
  .trim()  // Автоматическое удаление пробелов по краям
  .refine(isOkImgUrl, "Некорректный URL изображения (разрешены https/http, /uploads|/media, data:, blob:)");

/**
 * СХЕМА ОСНОВНОЙ ИНФОРМАЦИИ СТАТЬИ
 * 
 * Содержит основные мета-данные персонажа/объекта Warhammer 40,000:
 * - name: имя персонажа/объекта
 * - image: основное изображение
 * - age: возраст (с преобразованием строки в число)
 * - birthday: дата рождения/создания
 * - gender: пол/гендерная принадлежность
 * - appearance: описание внешности
 * - height: рост/высота
 * - weight: вес/масса
 * 
 * Все поля опциональны, .partial() делает всю схему необязательной
 * .coerce.number() автоматически преобразует строки в числа
 */
export const mainInfoSchema = z
  .object({
    name: z.string().trim().optional(),
    image: z.union([imgLike, z.literal("")]).optional(), // Разрешаем валидный URL или пустую строку
    age: z.coerce.number().int().positive().max(100000).optional(), // Преобразование + проверка на целое положительное число
    birthday: z.string().trim().optional(),
    gender: z.string().trim().optional(),
    appearance: z.string().trim().optional(),
    height: z.string().trim().optional(),
    weight: z.string().trim().optional(),
  })
  .partial(); // Все поля становятся необязательными

/**
 * СХЕМА ЭЛЕМЕНТА СПИСКА
 * 
 * Поддерживает два формата элементов списка:
 * 1. Простая строка: "Элемент списка"
 * 2. Объект с полем content: { content: "Элемент списка" }
 * 
 * .passthrough() позволяет объекту содержать дополнительные поля
 * что полезно для совместимости с разными форматами данных
 */
export const listItemSchema = z.union([
  z.string().trim(), // Простой строковый элемент
  z.object({ content: z.string().trim().optional() }).passthrough(), // Объект с содержимым
]);

/**
 * СХЕМА КОНТЕНТ-БЛОКОВ СТАТЬИ
 * 
 * Определяет структуру различных типов контент-блоков:
 * - h1: заголовок первого уровня
 * - h2: заголовок второго уровня  
 * - p: параграф текста
 * - image: изображение (может быть строкой или объектом с src)
 * - ul: неупорядоченный список
 * 
 * .or() в конце добавляет fallback для неизвестных типов блоков
 * что обеспечивает обратную совместимость при добавлении новых типов
 */
export const contentBlockSchema = z.union([
  // Заголовок первого уровня
  z.object({ type: z.literal("h1"),    content: z.string() }),
  // Заголовок второго уровня
  z.object({ type: z.literal("h2"),    content: z.string() }),
  // Текстовый параграф
  z.object({ type: z.literal("p"),     content: z.string() }),
  // Блок изображения - поддерживает два формата:
  // 1. Простая строка с URL
  // 2. Объект с полем src
  z.object({
    type: z.literal("image"),
    content: z.union([imgLike, z.object({ src: imgLike }).passthrough()]),
  }),
  // Неупорядоченный список из элементов listItemSchema
  z.object({ type: z.literal("ul"),    content: z.array(listItemSchema) }),
])
/**
 * FALLBACK ДЛЯ НЕИЗВЕСТНЫХ ТИПОВ БЛОКОВ
 * 
 * Обеспечивает обратную совместимость - если сервер пришлет новый тип блока,
 * приложение не упадет, а просто пропустит его валидацию
 * .passthrough() позволяет блоку содержать любые дополнительные поля
 */
.or(
  z
    .object({
      type: z.string().min(1), // Любая непустая строка для типа
      content: z.any(),        // Любое содержимое
    })
    .passthrough() // Разрешаем дополнительные поля в объекте
);

/**
 * Схема для массива контент-блоков
 * Используется для валидации основного содержимого статьи
 */
export const contentBlocksSchema = z.array(contentBlockSchema);

/**
 * ОСНОВНАЯ СХЕМА СТАТЬИ ДЛЯ СОЗДАНИЯ
 * 
 * Используется на странице создания новой статьи (NewArticlePage)
 * Содержит обязательные и опциональные поля:
 * - title: обязательное поле (3-200 символов)
 * - previewImg: обязательное изображение для превью
 * - mainInfo: опциональная основная информация
 * - mainContent: опциональные контент-блоки
 */
export const articleSchema = z.object({
  // Заголовок статьи - обязательное поле с ограничениями по длине
  title: z.string().trim().min(3, "Минимум 3 символа").max(200, "Максимум 200 символов"),
  // Превью-изображение - обязательно должно быть валидным URL изображения
  previewImg: imgLike,
  // Основная информация - опциональный объект
  mainInfo: mainInfoSchema.optional(),
  // Основное содержимое статьи - опциональный массив блоков
  // На практике отправляется отдельно через editorSlice, но оставлено для полноты
  mainContent: contentBlocksSchema.optional(),
});

/**
 * СХЕМА ОБНОВЛЕНИЯ ПРОФИЛЯ ПОЛЬЗОВАТЕЛЯ
 * 
 * Используется для обновления данных пользователя:
 * - name: имя пользователя (2-50 символов, опционально)
 * - ava: аватарка (валидный URL изображения или пустая строка, опционально)
 */
export const profileUpdateSchema = z.object({
  name: z.string().trim().min(2, "Минимум 2 символа").max(50, "Максимум 50 символов").optional(),
  ava: z.union([imgLike, z.literal("")]).optional(), // Разрешаем валидный URL или сброс аватарки (пустая строка)
});

/** ===== ВЫВОД ТИПОВ ИЗ СХЕМ ДЛЯ ИСПОЛЬЗОВАНИЯ В ТИПИЗАЦИИ ===== */

/**
 * Тип данных формы статьи - выводится из articleSchema
 * Используется в компонентах для типизации props и state
 */
export type ArticleFormData = z.infer<typeof articleSchema>;

/**
 * Тип основной информации - выводится из mainInfoSchema  
 * Используется для типизации мета-данных статей
 */
export type MainInfoData = z.infer<typeof mainInfoSchema>;

/**
 * Тип контент-блока - выводится из contentBlockSchema
 * Используется в редакторе статей для типизации блоков контента
 */
export type ContentBlockData = z.infer<typeof contentBlockSchema>;

/**
 * Тип данных для обновления профиля - выводится из profileUpdateSchema
 * Используется в компонентах профиля пользователя
 */
export type ProfileUpdateData = z.infer<typeof profileUpdateSchema>;

// ===== АРХИТЕКТУРНЫЕ ОСОБЕННОСТИ ВАЛИДАТОРОВ =====

/**
 * КЛЮЧЕВЫЕ ПРИНЦИПЫ ВАЛИДАЦИИ В ПРОЕКТЕ:
 * 
 * 1. БЕЗОПАСНОСТЬ И ГИБКОСТЬ:
 *    - Разрешаем только безопасные типы изображений
 *    - Fallback для неизвестных типов блоков предотвращает падения
 *    - .passthrough() обеспечивает совместимость с будущими расширениями
 * 
 * 2. ПОЛЬЗОВАТЕЛЬСКИЙ ОПЫТ:
 *    - Четкие сообщения об ошибках на русском языке
 *    - .trim() автоматически очищает ввод пользователя
 *    - .optional() поля не блокируют отправку формы
 * 
 * 3. ПРОИЗВОДИТЕЛЬНОСТЬ:
 *    - Переиспользуемые валидаторы (imgLike)
 *    - Эффективные регулярные выражения
 *    - Минимальные проверки для каждого случая
 * 
 * 4. СООТВЕТСТВИЕ ТЕМАТИКЕ WARHAMMER 40,000:
 *    - Поддержка сложных структур данных для описания персонажей
 *    - Гибкая система контент-блоков для богатого форматирования
 *    - Учет особенностей вселенной (возраст до 100000 лет)
 */

/**
 * ВАЖНЫЕ МОМЕНТЫ ДЛЯ РАЗРАБОТЧИКОВ:
 * 
 * - z.coerce.number() автоматически преобразует строки в числа
 * - z.union() позволяет объединять несколько типов валидации
 * - .refine() добавляет кастомную логику валидации
 * - .passthrough() сохраняет неизвестные поля при валидации
 * - z.literal() фиксирует конкретное значение строки
 * 
 * При добавлении новых типов контент-блоков необходимо:
 * 1. Добавить схему в contentBlockSchema
 * 2. Обновить тип ContentBlockData (автоматически через z.infer)
 * 3. Обеспечить обработку в компонентах редактора
 */

// Файл обеспечивает централизованное управление валидацией данных
// во всем приложении Warhammer 40,000 Fandom Wiki





// Основные особенности комментирования:

// 1. Структурные комментарии

// Общее описание файла и его назначения
// Разделы по функциональным группам
// Подробное описание каждой схемы

// 2. Технические детали

// Объяснение работы каждого валидатора
// Описание параметров и возвращаемых значений
// Пояснения по использованию методов Zod

// 3. Архитектурные принципы

// Объяснение принятых решений проектирования
// Причины использования определенных подходов
// Рекомендации для будущих расширений


// 4. Контекст Warhammer 40,000

// Учет особенностей тематики вселенной
// Объяснение бизнес-логики валидаторов
// Теперь код стал самодокументируемым и понятным для других разработчиков!



