import { Navigate, useLocation } from "react-router-dom";
import { useAppSelector } from "@/app/hooks";

/**
 * КОМПОНЕНТ ЗАЩИТЫ МАРШРУТОВ WARHAMMER 40,000 FANDOM WIKI
 * 
 * Higher-Order Component для защиты маршрутов, требующих аутентификации:
 * - Проверяет статус авторизации пользователя через Redux store
 * - Перенаправляет неавторизованных пользователей на страницу входа
 * - Сохраняет исходный маршрут для возврата после успешной аутентификации
 * 
 * Особенности:
 * - Интеграция с React Router для управления навигацией
 * - Использование состояния location для сохранения истории навигации
 * - Замена текущей записи в истории браузера для чистого UX
 */
export default function RequireAuth({ children }: { children: JSX.Element }) {
  /**
   * ПОЛУЧЕНИЕ СТАТУСА АУТЕНТИФИКАЦИИ ИЗ REDUX STORE
   * 
   * Использует кастомный хук useAppSelector для доступа к глобальному состоянию
   * isAuthed: boolean - флаг, указывающий авторизован ли пользователь
   */
  const isAuthed = useAppSelector((s) => s.auth.isAuthed);
  
  /**
   * ПОЛУЧЕНИЕ ТЕКУЩЕГО МАРШРУТА ИЗ REACT ROUTER
   * 
   * Хук useLocation предоставляет информацию о текущем URL и состоянии навигации
   * Используется для сохранения исходного маршрута при редиректе
   */
  const loc = useLocation();

  /**
   * ЛОГИКА ПРОВЕРКИ ДОСТУПА И ПЕРЕНАПРАВЛЕНИЯ
   * 
   * Если пользователь не авторизован:
   * 1. Выполняется редирект на страницу профиля (/profile)
   * 2. В состояние навигации сохраняется исходный маршрут (from)
   * 3. Текущий маршрут заменяется в истории браузера (replace: true)
   * 
   * Если пользователь авторизован - рендерит дочерние компоненты
   */
  if (!isAuthed) {
    /**
     * ПЕРЕНАПРАВЛЕНИЕ НА СТРАНИЦУ АУТЕНТИФИКАЦИИ
     * 
     * Компонент Navigate из React Router выполняет клиентский редирект:
     * - to="/profile": целевой маршрут для аутентификации
     * - state={{ from: loc }}: сохранение исходного маршрута для возврата
     * - replace: true: замена текущей записи в истории браузера
     */
    return <Navigate to="/profile" state={{ from: loc }} replace />;
  }

  /**
   * РЕНДЕРИНГ ЗАЩИЩЕННОГО КОНТЕНТА
   * 
   * Если пользователь авторизован - компонент возвращает переданные children
   * Это позволяет обернуть любые защищенные маршруты или компоненты
   */
  return children;
}






// Комментарии объясняют:

// 1. Архитектуру защиты маршрутов

// Higher-Order Component (HOC) паттерн для оборачивания защищенных компонентов
// Интеграцию с React Router через компонент Navigate и хуки
// Глобальное состояние аутентификации через Redux store

// 2. Механизм перенаправления и сохранения состояния

// Автоматический редирект при отсутствии аутентификации
// Сохранение исходного URL в состоянии навигации для возврата
// Очистку истории браузера через replace навигацию

// 3. Пользовательский опыт

// Плавную навигацию между защищенными и публичными маршрутами
// Автоматическое возвращение к запрошенной странице после входа
// Предотвращение доступа к защищенному контенту без авторизации

// 4. Технические особенности

// Типизацию пропсов для TypeScript безопасности
// Использование React Router хуков для работы с навигацией
// Интеграцию с Redux для доступа к глобальному состоянию

// 5. Безопасность и навигацию

// Клиентскую защиту маршрутов от неавторизованного доступа
// Сохранение контекста навигации для улучшения UX
// Согласованность с серверной аутентификацией

// Компонент RequireAuth обеспечивает надежную 
// защиту маршрутов в Warhammer 40,000 Fandom Wiki, 
// гарантируя что только авторизованные пользователи имеют доступ к 
// защищенным разделам приложения, при этом сохраняя удобство навигации и 
// возможность возврата к исходному запросу после успешной аутентификации.



