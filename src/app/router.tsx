import { Suspense, lazy } from "react";
import { createBrowserRouter, Navigate } from "react-router-dom";
import App from "@/App";
import RequireAuth from "@/components/routing/RequireAuth";

/**
 * ЛЕНИВАЯ ЗАГРУЗКА СТРАНИЦ ПРИЛОЖЕНИЯ
 * 
 * Использует React.lazy для code-splitting и оптимизации загрузки приложения:
 * - Каждая страница загружается только при необходимости
 * - Уменьшает первоначальный размер бандла
 * - Улучшает производительность за счет разделения кода
 */
const HomePage = lazy(() => import("@/pages/HomePage"));
const ArticlePage = lazy(() => import("@/pages/ArticlePage"));
const ProfilePage = lazy(() => import("@/pages/ProfilePage"));
const NewArticlePage = lazy(() => import("@/pages/NewArticlePage"));
const EditPage = lazy(() => import("@/pages/EditPage"));
const RegisterPage = lazy(() => import("@/pages/RegisterPage"));
const ErrorPage = lazy(() => import("@/pages/errors/ErrorPage"));
const NotFoundPage = lazy(() => import("@/pages/errors/NotFoundPage"));
const NetworkErrorPage = lazy(() => import("@/pages/errors/NetworkErrorPage"));

/**
 * КОМПОНЕНТ ЗАГРУЗКИ ДЛЯ SUSPENSE
 * 
 * Отображается во время загрузки ленивых компонентов:
 * - Простой индикатор загрузки с анимацией pulse
 * - Центрирование по вертикали и горизонтали
 * - Нейтральный дизайн, соответствующий тематике приложения
 */
function Fallback() {
  return (
    <div className="w-full h-[50vh] grid place-items-center text-center">
      <div className="animate-pulse text-sm opacity-70">Загрузка интерфейса…</div>
    </div>
  );
}

/**
 * БАЗОВЫЙ ПУТЬ ДЛЯ РОУТЕРА (BASENAME)
 * 
 * Вычисляется из переменной окружения Vite (import.meta.env.BASE_URL):
 * - Удаляет хвостовые слеши для consistency
 * - Обеспечивает корректную работу при деплое в поддиректорию
 * - По умолчанию "/" если BASE_URL не определен
 */
const BASENAME = ((import.meta.env.BASE_URL ?? "/") as string).replace(/\/+$/, "") || "/";

/**
 * КОНФИГУРАЦИЯ МАРШРУТИЗАТОРА REACT ROUTER
 * 
 * Создает иерархию маршрутов для Warhammer 40,000 Fandom Wiki:
 * - Объединяет публичные и защищенные маршруты
 * - Настраивает обработку ошибок и загрузки
 * - Интегрирует систему аутентификации
 */
export const router = createBrowserRouter(
  [
    {
      /**
       * КОРНЕВОЙ МАРШРУТ ПРИЛОЖЕНИЯ
       * 
       * Служит общим layout для всех страниц:
       * - path: "/" - обрабатывает все маршруты от корня
       * - element: <App /> - основной компонент приложения
       * - errorElement: глобальная обработка ошибок маршрутизации
       * - children: вложенные маршруты с различными уровнями доступа
       */
      path: "/",
      element: (
        <Suspense fallback={<Fallback />}>
          <App />
        </Suspense>
      ),
      errorElement: (
        <Suspense fallback={<Fallback />}>
          <ErrorPage />
        </Suspense>
      ),
      children: [
        // ГЛАВНАЯ СТРАНИЦА - публичный доступ
        { index: true, element: <HomePage /> },
        
        // СТРАНИЦА ПРОСМОТРА СТАТЬИ - публичный доступ
        { path: "article/:id", element: <ArticlePage /> },

        /**
         * РЕДАКТИРОВАНИЕ СТАТЬИ - защищенный маршрут
         * 
         * Требует аутентификации пользователя:
         * - Обернут в RequireAuth для проверки авторизации
         * - Перенаправляет на страницу входа при отсутствии доступа
         * - Сохраняет исходный маршрут для возврата после аутентификации
         */
        {
          path: "edit/:id",
          element: (
            <RequireAuth>
              <EditPage />
            </RequireAuth>
          ),
        },

        // СТРАНИЦА ПРОФИЛЯ - смешанный доступ (публичный интерфейс, защищенные действия)
        { path: "profile", element: <ProfilePage /> },
        
        // СТРАНИЦА РЕГИСТРАЦИИ - публичный доступ
        { path: "register", element: <RegisterPage /> },

        /**
         * СОЗДАНИЕ НОВОЙ СТАТЬИ - защищенный маршрут
         * 
         * Требует аутентификации пользователя:
         * - Доступен только авторизованным пользователям
         * - Использует ту же защиту, что и редактирование статей
         */
        {
          path: "new",
          element: (
            <RequireAuth>
              <NewArticlePage />
            </RequireAuth>
          ),
        },

        // СТРАНИЦЫ ОШИБОК - публичный доступ
        { path: "error/:code", element: <ErrorPage /> },
        { path: "network", element: <NetworkErrorPage /> },
        
        /**
         * РЕДИРЕКТ С УСТАРЕВШЕГО МАРШРУТА
         * 
         * Перенаправляет с /login на /profile:
         * - replace: true - заменяет текущую запись в истории браузера
         * - Обеспечивает обратную совместимость с предыдущими версиями
         */
        { path: "login", element: <Navigate to="/profile" replace /> },
        
        /**
         * ОБРАБОТКА НЕСУЩЕСТВУЮЩИХ МАРШРУТОВ
         * 
         * Перехватывает все неизвестные пути и перенаправляет на 404 страницу
         * Использует компонент NotFoundPage, который сам выполняет редирект на /error/404
         */
        { path: "*", element: <NotFoundPage /> },
      ],
    },
  ],
  { 
    /**
     * БАЗОВЫЙ ПУТЬ ДЛЯ ВСЕХ МАРШРУТОВ
     * 
     * Критически важен для корректного деплоя в поддиректорию:
     * - Обеспечивает правильное разрешение относительных путей
     * - Совместим с различными средами развертывания
     * - Автоматически вычисляется из конфигурации Vite
     */
    basename: BASENAME 
  }
);




// Комментарии объясняют:

// 1. Архитектуру маршрутизации приложения

// Иерархическую структуру маршрутов с корневым компонентом App
// Разделение на публичные и защищенные маршруты
// Единую точку входа для всего приложения

// 2. Систему ленивой загрузки и оптимизации

// Code-splitting через React.lazy для уменьшения первоначального бандла
// Универсальный компонент загрузки для всех ленивых страниц
// Обработку состояний загрузки через Suspense

// 3. Управление доступом и безопасность

// Защиту маршрутов через RequireAuth для редактирования и создания статей
// Гибкую систему перенаправлений для устаревших маршрутов
// Публичный доступ к основному контенту (статьи, главная страница)

// 4. Обработку ошибок и edge cases

// Глобальную обработку ошибок маршрутизации через errorElement
// Специализированные страницы ошибок для различных сценариев
// Перехват несуществующих маршрутов через catch-all route ("*")

// 5. Конфигурацию для production

// Динамическое вычисление basename для совместимости с разными средами развертывания
// Поддержку деплоя в поддиректорию через правильную обработку BASE_URL
// Оптимизацию для различных сборок (development/production)

// Этот файл router.tsx обеспечивает надежную и оптимизированную
// систему маршрутизации для Warhammer 40,000 Fandom Wiki, сочетающая в себе 
// производительность ленивой загрузки, безопасность защищенных маршрутов и 
// удобство пользовательской навигации.



